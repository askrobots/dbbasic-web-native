name: Semantic Components Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Tier 1: FREE tests - Run on every commit
  fast-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: Run structure tests (FREE)
        run: python3 test_structure.py

      - name: Run integration tests (FREE)
        run: python3 test_integration.py

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-fast
          path: test-results/

  # Tier 2: CHEAP tests - Run on PR
  comprehensive-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    needs: fast-tests
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic
          pip install -r requirements.txt
          playwright install chromium

      - name: Run voice tests (~$0.01)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 test_voice.py

      - name: Run context tests (FREE)
        run: python3 test_context.py

      - name: Run gesture tests (FREE)
        run: python3 test_gestures.py

      - name: Run attention tests (FREE)
        run: python3 test_attention.py

      - name: Run performance tests (FREE)
        run: python3 test_performance.py

      - name: Upload comprehensive results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-comprehensive
          path: test-results/

  # Tier 3: EXPENSIVE tests - Run nightly only
  visual-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: fast-tests
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Generate documentation
        run: node generate-docs.js

      - name: Run AI vision tests (~$0.50)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 test_visual_ai.py

      - name: Upload visual results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-visual
          path: |
            test-results/results-ai.json
            test-results/accessibility-report-ai.html
            screenshots/

  # Summary report
  test-summary:
    runs-on: ubuntu-latest
    if: always()
    needs: [fast-tests, comprehensive-tests, visual-tests]
    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tier 1: Fast Tests (FREE)" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results-fast/results-structure.json ]; then
            echo "âœ… Structure tests completed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f test-results-fast/results-integration.json ]; then
            echo "âœ… Integration tests completed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d test-results-comprehensive ]; then
            echo "### Tier 2: Comprehensive Tests (~$0.01)" >> $GITHUB_STEP_SUMMARY
            if [ -f test-results-comprehensive/results-voice.json ]; then
              echo "âœ… Voice command tests completed" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f test-results-comprehensive/results-context.json ]; then
              echo "âœ… Context tests completed (mobile/tablet/desktop)" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f test-results-comprehensive/results-gestures.json ]; then
              echo "âœ… Gesture tests completed" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f test-results-comprehensive/results-attention.json ]; then
              echo "âœ… Attention budget tests completed" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f test-results-comprehensive/results-performance.json ]; then
              echo "âœ… Performance tests completed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f test-results-visual/results-ai.json ]; then
            echo "### Tier 3: Visual Tests (~$0.50)" >> $GITHUB_STEP_SUMMARY
            echo "âœ… AI vision tests completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
